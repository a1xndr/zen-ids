# ZenIDS
Introspective intrusion detection system for PHP applications.

This repository contains the dynamically linked ZenIDS extension for the reference implementation of the PHP interpreter. This extension requires a slightly modified version of PHP, which can be found in the `interp-opt` branch of the [zen-ids-php](https://github.com/uci-plrg/zen-ids-php) repository.

### Build

1. Dependencies:
  * `interp-opt` branch of the [zen-ids-php](https://github.com/uci-plrg/zen-ids-php) repository
  * `interp-opt` branch of this repository
2. Environment:
  * Set `$PHP_HOME` to the top-level directory of the local [zen-ids-php](https://github.com/uci-plrg/zen-ids-php) clone.
  * Set `$ZEN_IDS_HOME` to the top-level directory of this repository.
  * Set `$ZEN_IDS_DATASETS` to any directory where the profile data can be stored.
    * This location should have plenty of disk space for large applications and/or extensive profiling and monitoring.
    * Specifying a fast disk, especially an SSD, will improve overall performance.
  * Set `$ZEN_IDS_EVOLUTION` to any directory where evolution metadata can be stored.
    * This location is less write-intensive than the dataset directory, but disk speed still may affect performance.
3. Build:
  * `cd opmon && $PHP_HOME/scripts/phpize && ./current-config && make -j && sudo make -j install`
    * Use option `current-config -d` for a debug build.

### Configure

1. `cd $PHP_HOME && mkdir conf.d/ext && cp $ZEN_IDS_HOME/opmon.ini.default $PHP_HOME/conf.d/ext/opmon.ini`
2. Add all the variables defined in the "Environment" section (above) to the PHP script `/etc/apache2/envvars`.
  * To source a script that defines these variables, use syntax `. /path/to/.zen-ids-rc`.
  * Note that the bash keyword `source` is not recognized in this file.
3. `sudo chown -R www-data:www-data $ZEN_IDS_EVOLUTION` (or whatever user is running your Apache HTTP server)

### Test

1. Add the [scripts](https://github.com/uci-plrg/zen-ids/tree/interp-opt/scripts) directory to the `$PATH`
  * Same for all dependent projects and tool projects
1. Create a sample PHP file, e.g.:
  * `echo "<?php phpinfo(); ?>" > /var/www/html/info.php`
2. Start apache
  * To debug apache, use script `adb`
3. Load `$host/info.php` in a browser (or `wget "http://$host/info.php"`)
4. Find the CFI profile generated by ZenIDS:
  * `ls -lh $(select-run -w 1)/*/unknown`

### Tools

1. Application profiles can be built with the Java tools in the [zen-ids-profile](https://github.com/uci-plrg/zen-ids-profile) project. 
  * In the paper, these are referred to as *trusted profiles*.
  * See the next section on "Experiments" for details.
 
### Experiments

See the [experiment documentation](https://github.com/uci-plrg/zen-ids/blob/interp-opt/EXPERIMENTS.md).
