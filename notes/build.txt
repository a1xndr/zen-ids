
--------------
Build PHP
--------------

This build of PHP requires the environment variable PHP_HOME.

First install the pre-requisites:
$PHP_HOME/fix-bison

apt-get install autoconf apache2-dev libxml2 libxml2-dev libssl-dev libcurl4-openssl-dev pkg-config libicu-dev libmcrypt-dev libtidy-dev libxslt1.1 libxslt1-dev libjpeg-dev libpng12-dev

# manually install libxdiff
cd /hd/temp
wget http://www.xmailserver.org/libxdiff-0.23.tar.gz
tar -xzf libxdiff-0.23.tar.gz
cd libxdiff-0.23
./configure
make
make install

Next build php: go to the top-level php directory and:

1. ./buildconf
2. ./current-config # it does this:
      ./configure
        --prefix=$PHP_HOME
        --enable-zend-monitor
        --with-config-file-path=$PHP_HOME/conf.d
        --with-config-file-scan-dir=$PHP_HOME/conf.d/ext
3. make -j3
4. make install

Seems to require bison 2.7, which is not available on 14.04. This
nonsense is corrected by fix-bison (run him as root!):

wget http://launchpadlibrarian.net/140087283/libbison-dev_2.7.1.dfsg-1_amd64.deb
wget http://launchpadlibrarian.net/140087282/bison_2.7.1.dfsg-1_amd64.deb
dpkg -i libbison-dev_2.7.1.dfsg-1_amd64.deb
dpkg -i bison_2.7.1.dfsg-1_amd64.deb

----------------
Build opmon
----------------

To build the opcode-monitor extension:

   > cd opmon
   > ../../php/scripts/phpize  # may need to set it executable (requires autoconf)
   > ./current-config # it does something like this:
        configure     # (generated by the preceding `phpize` step)
          --enable-opcode-monitor
          --prefix=$PHP_HOME
          --with-php-config=$PHP_HOME/bin/php-config
   > make -j3 install

Next configure php with the opmon extension:

   > cd $PHP_HOME
   > mkdir conf.d/ext
   > scp $similar conf.d/ext/opmon.ini

Open the opmon.ini file and change the paths for this machine.

After installing for the first time, php needs to be rebuilt:

   > cd $PHP_HOME
   > make install

----------------
Rebuild opmon
----------------

To rebuild the opcode-monitor extension after changing the source file set:

   > cd opmon
   > rm configure
   > rm -rf autom4te.cache
   > ../../php/scripts/phpize
   > ./current-config


----------------
Configure apache
----------------

   > a2dismod mpm_event
   > a2enmod mpm_prefork
   > cd /etc/apache2
   > scp $similar mods-enabled/php7.conf
   > cp mods-enabled/php7.conf mods-available/php7.conf

----------------
Miscellaneous
----------------

When checking out php-cfi for the first time, it may be necessary to
copy the apache includes from the local apache install into php-cfi/opmon/include, e.g.:

   cp /usr/include/apache2/* include
   cp /usr/include/apr-1.0/* include

If these are in a different location, use "locate apache_noprobes.h" and
"locate apr.h" to find them.

